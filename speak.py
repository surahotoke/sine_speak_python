import numpy as np
import sounddevice as sd

# éŸ³å£°ãƒ‡ãƒ¼ã‚¿ï¼ˆdB, Hzï¼‰
phonemes = {
    'ã‚': [[-39, 106], [-41, 212], [-41, 318], [-47, 424], [-45, 530], [-41, 636], [-36, 742], [-35, 848], [-46, 954], [-45, 1060], [-49, 1166], [-43, 1272], [-51, 1378], [-61, 1484], [-68, 1590], [-74, 1802], [-77, 1908], [-75, 2014], [-72, 2650], [-71, 2756], [-80, 2862], [-74, 3286]],
    'ã„': [[-39, 106], [-44, 212], [-38, 318], [-64, 424], [-65, 530], [-80, 636], [-81, 742], [-78, 848], [-80, 1060], [-81, 2332], [-75, 2438], [-75, 2544], [-79, 2650], [-82, 2756], [-75, 3498], [-77, 3604]],
    'ã†': [[-39, 106], [-46, 212], [-38, 318], [-44, 424], [-58, 530], [-78, 636], [-68, 742], [-73, 848], [-66, 954], [-69, 1060], [-71, 1166], [-69, 1272], [-62, 1378], [-65, 1484], [-75, 1590], [-78, 1696], [-76, 2438], [-70, 2544], [-81, 3750]],
    'ãˆ': [[-39, 106], [-43, 212], [-43, 318], [-40, 424], [-45, 530], [-56, 636], [-54, 742], [-62, 848], [-66, 954], [-66, 1060], [-71, 1166], [-73, 1272], [-72, 1378], [-71, 1484], [-74, 1590], [-74, 1696], [-76, 1802], [-72, 1908], [-68, 2014], [-66, 2120], [-64, 2226], [-56, 2332], [-64, 2438], [-64, 2544], [-66, 2650], [-63, 2756], [-64, 2862], [-62, 2968]],
    'ãŠ': [[-39, 106], [-46, 212], [-42, 318], [-39, 424], [-45, 530], [-54, 636], [-49, 742], [-47, 848], [-51, 954], [-69, 1060], [-71, 1166], [-76, 1272], [-77, 1378], [-76, 1484], [-79, 2544], [-72, 2650]],
    'ã‚“': [[-39, 106], [-41, 214], [-43, 323], [-47, 431], [-64, 533], [-65, 641], [-67, 743], [-70, 851], [-72, 958], [-70, 1066], [-73, 1174], [-76, 1281], [-70, 1400], [-68, 1486], [-71, 1593], [-79, 1701], [-83, 1809], [-78, 1916], [-77, 2024], [-75, 2132], [-79, 2239], [-80, 2347], [-75, 2455], [-79, 2562]]
}
# åˆæˆéŸ³ãƒ«ãƒ¼ãƒ«
compound_phonemes = {
    'ãª': ['ã‚“', 'ã‚'],
    'ã«': ['ã‚“', 'ã„'],
    'ã¬': ['ã‚“', 'ã†'],
    'ã­': ['ã‚“', 'ãˆ'],
    'ã®': ['ã‚“', 'ãŠ'],
    'ã‚„': ['ã„', 'ã‚'],
    'ã‚†': ['ã„', 'ã†'],
    'ã‚ˆ': ['ã„', 'ãŠ'],
    'ã‚': ['ã†', 'ã‚'],
    'ã‚’': ['ã†', 'ãŠ'],
    'ã„ã‡': ['ã„', 'ãˆ'],
    'ã†ãƒ': ['ã†', 'ã„'],
    'ã†ã‡': ['ã†', 'ãˆ'],
    'ã«ã‚ƒ': ['ã«', 'ã‚„'],
    'ã«ã‚…': ['ã«', 'ã‚†'],
    'ã«ã‡': ['ã«', 'ãˆ'],
    'ã«ã‚‡': ['ã«', 'ã‚ˆ'],
}
alphabet_list = {
    'a': 'ãˆãƒ¼',
    'e': 'ã„ãƒ¼',
    'i': 'ã‚ã„',
    'n': 'ãˆã¬',
    'o': 'ãŠãƒ¼',
    'u': 'ã‚†ãƒ¼',
    'y': 'ã‚ã„',
    'A': 'ãˆãƒ¼',
    'E': 'ã„ãƒ¼',
    'I': 'ã‚ã„',
    'N': 'ãˆã¬',
    'O': 'ãŠãƒ¼',
    'U': 'ã‚†ãƒ¼',
    'Y': 'ã‚ã„',
    ',': 'ã€',
    '.': 'ã€‚',
    ' ': 'ã£'
}
word_replace_list = {
    'an': 'ã‚ã‚“',
    'eye': 'ã‚ã„',
    'in': 'ã„ã‚“',
    'now': 'ãªã†',
    'nan': 'ãªã‚“',
    'knee': 'ã«ãƒ¼',
    'no': 'ã®ãƒ¼',
    'know': 'ã®ãƒ¼',
    'none': 'ãªã‚“',
    'on': 'ãŠã‚“',
    'yeah': 'ã‚„ãƒ¼',
    'you': 'ã‚†ãƒ¼',
    'yen': 'ã„ã‡ã‚“',
    'war': 'ã†ã‰ãƒ¼',
    ', ': 'ã€',
    '. ': 'ã€‚'
}
kana_list = {
    'ã‚¢': 'ã‚',
    'ã‚¤': 'ã„',
    'ã‚¦': 'ã†',
    'ã‚¨': 'ãˆ',
    'ã‚ª': 'ãŠ',
    'ãƒŠ': 'ãª',
    'ãƒ‹': 'ã«',
    'ãƒŒ': 'ã¬',
    'ãƒ': 'ã­',
    'ãƒ': 'ã®',
    'ãƒ¤': 'ã‚„',
    'ãƒ¦': 'ã‚†',
    'ãƒ¨': 'ã‚ˆ',
    'ãƒ¯': 'ã‚',
    'ãƒ²': 'ã‚’',
    'ãƒ³': 'ã‚“',
    'ã‚£': 'ãƒ',
    'ã‚§': 'ã‡',
    'ãƒ£': 'ã‚ƒ',
    'ãƒ¥': 'ã‚…',
    'ãƒ§': 'ã‚‡',
    'ãƒƒ': 'ã£'
}
kanji_list = {
    'é˜¿': 'ã‚',
    'äºœ': 'ã‚',
    'åˆ': 'ã‚',
    'ä¼š': 'ã‚',
    'æ„›': 'ã‚ã„',
    'é’': 'ã‚ãŠ',
    'è’¼': 'ã‚ãŠ',
    'ç©´': 'ã‚ãª',
    'å…„': 'ã‚ã«',
    'å§‰': 'ã‚ã­',
    'é®': 'ã‚ã‚†',
    'æ³¡': 'ã‚ã‚',
    'æ¡ˆ': 'ã‚ã‚“',
    'åºµ': 'ã‚ã‚“',
    'èƒƒ': 'ã„',
    'ä¼Š': 'ã„',
    'äº•': 'ã„',
    'æ„': 'ã„',
    'åŒ»': 'ã„',
    'å§”': 'ã„',
    'ä½': 'ã„',
    'å¨': 'ã„',
    'å±…': 'ã„',
    'è¨€': 'ã„',
    'å®¶': 'ã„ãˆ',
    'å¦': 'ã„ãª',
    'çŠ¬': 'ã„ã¬',
    'æˆŒ': 'ã„ã¬',
    'ç¨²': 'ã„ã­',
    'å«Œ': 'ã„ã‚„',
    'å²©': 'ã„ã‚',
    'ç¥': 'ã„ã‚',
    'é™¢': 'ã„ã‚“',
    'å°': 'ã„ã‚“',
    'æ·«': 'ã„ã‚“',
    'éŸ»': 'ã„ã‚“',
    'å“¡': 'ã„ã‚“',
    'éš ': 'ã„ã‚“',
    'å¯': 'ã†',
    'ä¸Š': 'ã†ãˆ',
    'ç•': 'ã†ã­',
    'é‹': 'ã†ã‚“',
    'çµµ': 'ãˆ',
    'æ±Ÿ': 'ãˆ',
    'è‹±': 'ãˆã„',
    'æ „': 'ãˆã„',
    'æ°¸': 'ãˆã„',
    'å††': 'ãˆã‚“',
    'ç‚': 'ãˆã‚“',
    'åœ’': 'ãˆã‚“',
    'å°¾': 'ãŠ',
    'å¾¡': 'ãŠ',
    'ç‹': 'ãŠã†',
    'æ¬§': 'ãŠã†',
    'å¤š': 'ãŠãŠ',
    'é¬¼': 'ãŠã«',
    'æ–§': 'ãŠã®',
    'è¦ª': 'ãŠã‚„',
    'æ©': 'ãŠã‚“',
    'å¥³': 'ãŠã‚“ãª',
    'å': 'ãª',
    'å¥ˆ': 'ãª',
    'è': 'ãª',
    'å†…': 'ãªã„',
    'è‹—': 'ãªãˆ',
    'å°š': 'ãªãŠ',
    'ä¸ƒ': 'ãªãª',
    'ç¸„': 'ãªã‚',
    'ä½•': 'ãªã‚“',
    'äºŒ': 'ã«',
    'è·': 'ã«',
    'ç…®': 'ã«',
    'è´„': 'ã«ãˆ',
    'åŒ‚':'ã«ãŠ',
    'åº­': 'ã«ã‚',
    'å¿': 'ã«ã‚“',
    'å¦Š': 'ã«ã‚“',
    'ç¸«': 'ã¬',
    'å¡—': 'ã¬',
    'éµº': 'ã¬ãˆ',
    'å¸ƒ': 'ã¬ã®',
    'å€¤': 'ã­',
    'éŸ³': 'ã­',
    'å¯': 'ã­',
    'æ ¹': 'ã­',
    'å¯§': 'ã­ã„',
    'å§': 'ã­ãˆ',
    'å¹´': 'ã­ã‚“',
    'å¿µ': 'ã­ã‚“',
    'é‡': 'ã®',
    'ä¹—': 'ã®',
    'å‘‘': 'ã®',
    'é£²': 'ã®',
    'è„³': 'ã®ã†',
    'èƒ½': 'ã®ã†',
    'è¾²': 'ã®ã†',
    'ç´': 'ã®ã†',
    'çŸ¢': 'ã‚„',
    'å±‹': 'ã‚„',
    'å…«': 'ã‚„',
    'ç„¼': 'ã‚„',
    'æ¶': 'ã‚„',
    'æŸ”': 'ã‚„ã‚',
    'è»Ÿ': 'ã‚„ã‚',
    'æ¹¯': 'ã‚†',
    'å–©': 'ã‚†',
    'æ²¹': 'ã‚†',
    'å”¯': 'ã‚†ã„',
    'å„ª': 'ã‚†ã†',
    'å¤•': 'ã‚†ã†',
    'æ‚ ': 'ã‚†ã†',
    'æ•…': 'ã‚†ãˆ',
    'ä¸–': 'ã‚ˆ',
    'è‰¯': 'ã‚ˆ',
    'ä½™': 'ã‚ˆ',
    'å¤œ': 'ã‚ˆ',
    'ä¸': 'ã‚ˆ',
    'é…”': 'ã‚ˆ',
    'ç”¨': 'ã‚ˆã†',
    'è¦': 'ã‚ˆã†',
    'é™½': 'ã‚ˆã†',
    'æ´‹': 'ã‚ˆã†',
    'æ›œ': 'ã‚ˆã†',
    'å¼±': 'ã‚ˆã‚',
    'é½¢': 'ã‚ˆã‚ã„',
    'å››': 'ã‚ˆã‚“',
    'å’Œ': 'ã‚',
    'è©±': 'ã‚',
    'å€­': 'ã‚',
    'ç½ ': 'ã‚ãª',
    'é°': 'ã‚ã«',
    'æ¹¾': 'ã‚ã‚“',
    'æ¤€': 'ã‚ã‚“'
}
replace_list = {**alphabet_list, **kana_list, **kanji_list}
# å˜ç‹¬éŸ³ + åˆæˆéŸ³ + è¨˜å· + æ¼¢å­—
available_char = set(phonemes.keys()) | set(compound_phonemes.keys()) | {'ãƒ¼', 'ã£', 'ã€', 'ã€‚'} | set(replace_list.keys() | set(word_replace_list.keys()))
# ã‚½ãƒ¼ãƒˆã™ã‚‹
available_char = " | ".join(sorted(available_char))

def shift_frequencies(data, key_shift):
    ratio = 2 ** (key_shift / 12)
    return [[db, freq * ratio] for db, freq in data]
# dB â†’ æŒ¯å¹…å¤‰æ›
def db_to_amplitude(db):
    return 10 ** (db / 20)
def adjust_duration(duration, key_shift=0):
    pitch_ratio = 106 * 2 ** (key_shift / 12)
    return round(pitch_ratio * duration) / pitch_ratio
# éŸ³å£°ç”Ÿæˆ
def synthesize_sound(data, duration, key_shift=0):
    data = shift_frequencies(data, key_shift)
    t = np.linspace(0, adjust_duration(duration, key_shift), int(48000 * adjust_duration(duration, key_shift)), endpoint=False)
    signal = np.zeros_like(t)
    for db, freq in data:
        amp = db_to_amplitude(db)
        tone = amp * np.sin(2 * np.pi * freq * t)
        signal += tone
    return signal / np.max(np.abs(signal))
# å†èµ·ãƒ•ãƒ¬ãƒ¼ã‚ºåˆ†ã‘
def resolve_phoneme_parts(char):
    if char in phonemes:
        return [char]
    elif char in compound_phonemes:
        parts = []
        for p in compound_phonemes[char]:
            parts.extend(resolve_phoneme_parts(p))
        # é‡è¤‡é™¤å»ï¼ˆé †åºä¿æŒï¼‰
        return list(dict.fromkeys(parts))
    else:
        return []
# ãƒ¡ã‚¤ãƒ³é–¢æ•°
def speak_kana(text, key_shift=0):
    signals = []
    i = 0
    last_vowel = None
    while i < len(text):
        if text[i] in pause_map:
            silence = np.zeros(int(48000 * pause_map[text[i]]))
            signals.append(silence)
            i += 1
        elif text[i] == "ãƒ¼" and last_vowel:
            sig = synthesize_sound(last_vowel, prolong_duration, key_shift)
            signals.append(sig)
            i += 1
        else:
            silence = np.zeros(int(48000 * normal_duration))
            signals.append(silence)
            matched = False
            # æœ€å¤§2æ–‡å­—ã®åˆæˆéŸ³ã‚’ãƒã‚§ãƒƒã‚¯
            for length in [2, 1]:
                if i + length <= len(text):
                    part = text[i:i+length]
                    parts = resolve_phoneme_parts(part)
                    if parts:
                        for j, p in enumerate(parts):
                            duration = conso_duration if j < len(parts) - 1 else full_duration - j * conso_duration
                            sig = synthesize_sound(phonemes[p], duration, key_shift)
                            signals.append(sig)
                        last_vowel = phonemes[parts[-1]]
                        i += length
                        matched = True
                        break
            if not matched:
                print(f"âš ï¸ æœªå¯¾å¿œã®æ–‡å­—: ã€Œ{text[i]}ã€")
                i += 1

    if signals:
        full_signal = np.concatenate(signals)
        sd.play(full_signal)
        sd.wait()
    else:
        print("âš ï¸ æœ‰åŠ¹ãªéŸ³ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
# æ–‡å­—åˆ—ã‚’ã²ã‚‰ä»®åã«å¤‰æ›ã™ã‚‹é–¢æ•°
def to_kana(text):
    result = ''
    i = 0
    while i < len(text):
        matched = False
        for length in [4, 3, 2]:
            if i + length <= len(text) and text[i:i+length] in word_replace_list:
                result += word_replace_list[text[i:i+length]]
                i += length
                matched = True
                break
        if not matched:
            if text[i] in replace_list:
                result += replace_list[text[i]]
            else:
                result += text[i]
            i += 1
    return result
# æ¼¢å­—å¯¾å¿œç‰ˆspeaké–¢æ•°
def speak(text, key_shift=0):
    kana_text = to_kana(text)
    print("\n\nä½¿ç”¨å¯èƒ½ãªæ–‡å­—ï¼š\n"+available_char+"\n\n")
    print(f"ğŸ—£ï¸ åŸæ–‡ã€€ã€€: {text}")
    print(f"ğŸ—£ï¸ èª­ã¿ä»®å: {kana_text}\n")
    speak_kana(kana_text, key_shift)
# è¨­å®šï¼ˆå˜ä½ï¼šç§’ï¼‰
normal_duration = 0.03
full_duration = 0.14
conso_duration = 0.05
prolong_duration = 0.16
pause_map = {
    'ã£': 0.12,
    'ã€': 0.3,
    'ã€‚': 0.6,
}
speak("yeah, ã‚ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ‹ãƒ¥ãƒ‹ãƒ¥ãƒ‹ãƒ¥ã€ã‚¤ãƒƒãƒŒã‚¤ãƒƒãƒŒã€‚ã‚ã®å¥³ã®å§‰ã®çŠ¬ã‚„å…„ã®ãƒ‹ãƒ£ãƒ³ãƒ‹ãƒ£ãƒ³ã€é’ã„ã­ãƒ¼ã€‚ã‚ã®çµµã€ä½•å††ãªã®ã€‚I no nan you.", 2)